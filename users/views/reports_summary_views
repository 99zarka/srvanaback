from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from rest_framework.permissions import IsAuthenticated
from django.db.models import Sum, Count, Avg
from django.utils import timezone
from datetime import timedelta
from orders.models import Order
from payments.models import Payment
from reviews.models import Review
from users.models import User
from issue_reports.models import IssueReport
from api.permissions import IsAdminUser

class ReportsSummaryAPIView(APIView):
    permission_classes = [IsAdminUser]

    def get(self, request, *args, **kwargs):
        if not request.user.user_type.user_type_name == 'admin':
            return Response({"detail": "You are not authorized to view reports summary."},
                            status=status.HTTP_403_FORBIDDEN)

        today = timezone.now().date()
        start_of_month = today.replace(day=1)

        # Current month revenue and services
        monthly_revenue = Order.objects.filter(
            order_status='completed',
            created_at__gte=start_of_month
        ).aggregate(Sum('final_price'))['final_price__sum'] or 0.00

        monthly_services = Order.objects.filter(
            order_status='completed',
            created_at__gte=start_of_month
        ).count()

        # Previous month for comparison
        prev_month_start = (start_of_month - timedelta(days=1)).replace(day=1)
        prev_month_revenue = Order.objects.filter(
            order_status='completed',
            created_at__gte=prev_month_start,
            created_at__lt=start_of_month
        ).aggregate(Sum('final_price'))['final_price__sum'] or 0.00

        prev_month_services = Order.objects.filter(
            order_status='completed',
            created_at__gte=prev_month_start,
            created_at__lt=start_of_month
        ).count()

        # Calculate percentage changes
        revenue_change = self._calculate_percentage_change(prev_month_revenue, monthly_revenue)
        services_change = self._calculate_percentage_change(prev_month_services, monthly_services)

        # New users this month
        new_users_month = User.objects.filter(
            date_joined__gte=start_of_month
        ).count()

        prev_month_users = User.objects.filter(
            date_joined__gte=prev_month_start,
            date_joined__lt=start_of_month
        ).count()

        users_change = self._calculate_percentage_change(prev_month_users, new_users_month)

        # Issue reports analytics
        total_issue_reports = IssueReport.objects.count()
        open_issues = IssueReport.objects.filter(status='open').count()
        resolved_issues = IssueReport.objects.filter(status='resolved').count()

        return Response({
            'total_revenue': round(monthly_revenue, 2),
            'revenue_change_percentage': f"+{revenue_change}%" if revenue_change >= 0 else f"{revenue_change}%",
            'completed_services': monthly_services,
            'completed_services_change_percentage': f"+{services_change}%" if services_change >= 0 else f"{services_change}%",
            'new_users': new_users_month,
            'new_users_change_percentage': f"+{users_change}%" if users_change >= 0 else f"{users_change}%",
            'total_issue_reports': total_issue_reports,
            'open_issues': open_issues,
            'resolved_issues': resolved_issues
        }, status=status.HTTP_200_OK)

    def _calculate_percentage_change(self, old_value, new_value):
        """Calculate percentage change between two values"""
        if old_value == 0:
            return 100 if new_value > 0 else 0
